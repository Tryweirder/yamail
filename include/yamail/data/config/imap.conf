system {
  daemon 1 2; // darmin
  verbose 44; /* dddd */
  uid "imap";
  gid "imap";
  dir /var/log/yimap;
  pid /var/run/yimap.pid;

  libpaths [ /usr/lib64 /usr/lib64/modules ];
};

log {
  core { DisableLogging false; };

  sink Console { 
         Destination Console;
         Filter "not %CustomLog%";
         FileName /var/log/yimap.log;
         AutoFlush true;
         Asyncronous true;
         Format "[%TimeStamp%] [%LineID%] %UniqID%: %_%";
  };
}; // log

module stat_server {
  type service_object;
  library ymod_statserver;
  factory ymod_stat_server::impl;

  configuration {
    io_threads 2;
    endpoints {
      listen 0.0.0.0:144 {
        read_timeout 120s;
        write_timeout 120s;
        keep_alive off;
        profile on;
      };
    };
  };
};

module auth { 
  type service_object;
  library ymod_blackbox;
  factory ymod_blackbox::auth_impl;

  configuration {
    default_domain yandex.ru;
    io_threads 4;
    queue_capacity 2000;
    retries 3;

    host_file /etc/yamail/blackbox_list.conf;
    url http://blackbox.yandex.net/blackbox;
    authtype imap;
  };
};

module http {
  type service_object;
  library ymod_httpclient;
  factory ymod_http_client::call_impl;

  log {
    sink XmlApiFile {
      Destination RotateTextFile;
      Filter "%XmlApi%";
      FileName /var/log/yimap/api.log;
      AutoFlush true;
      Format "[%TimeStamp%] %_%";
    };
  };

  configuration {
    io_threads 16;
    net_settings {
      user_agent  imap.yandex.ru;
      url         http://localhost.localdomain:8080/api;
      fallback    http://imap.yandex.ru:8080/api;

      timeouts {
        connect 400ms;
        resolve 5s;
        write   30s;
        read    300s;
      };
    };
  };
};

module imap_server {
  type service_object;
  library ymod_imapserver;
  factory yimap::server::impl;

  log { 
    sink ImapServClients {
      Destination MultiFile;
      Filter "%ImapServCmd%";
      Directory /var/log/yimap/clients/;
      AttrName ImapServIp;
    };
  };

  configuration {
    io_threads 10;

    ssl_context {
      cert_file /etc/yimap/ssl/imap.yandex.ru.crt;
      key_file /etc/yimap/ssl/imap.yandex.ru.key;
      // dh_file;
      // password;
    };

    endpoints {
      network-settings {
        autologout_init 60s;
        autologout 35m;
        autologount_idle 6h;

        limits {
          bad_commands 100;
          parallel_commands 5;
          same_commands_per_minute 30;
          command_size 42991616;
          literal_size 42991616;
          all_literals_size 42991616;
        };

        tcp_keep_alive {
          idle 160;
          interval 60;
          count 5;
        };

        tcp_linger2 30;

        auth_cfg {
          service pop;
          // domain;
          sid 0;
          force_encryption off;
        };
      };

      listen 0.0.0.0:143 {
        ssl tls;
        force_ssl off;
        %import network-settings into aa;
      };

      listen 0.0.0,0:993 {
        ssl on;
        force_ssl on;

        %import network-settings;
      };
    };
  };
};

module imap_parser {
  type service_object;
  library ymod_imapparser;
  factory yimap::parser::parser_impl;

  configuration {
    threads 8;
  };
};

module imap_processor {
  // type service_object;
  factory yimap::processor::task_impl@ymod_imapprocessor;

  log {
    sink ImapErrorFile {
      Destination RotateTextFile;
      Filter "%ImapProcErr%";
      FileName /var/log/yimap/error.log;
      AutoFlush on;
      Asynchronous true;
      Format "[%TimeStamp%] %_%";
    };

    sink ImapAuthFile {
      Destination RotateTextFile;
      Filter "%ImapAuthErr%";
      FileName /var/log/yimap/auth.log;
      AutoFlush on;
      Asynchronous true;
      Format "[%TimeStamp%] %_%";
    };
  };

  configuration {
    idle_extension off;
    threads 8;

    enqueue_timeout off;
    queue_capacity 10000;
    imap_folders_encoding UTF-7-IMAP;
    search_backend_host http://msearch-proxy.mail.yandex.net:80;
    auth_cookie "iMAP.aUTH=%1%:imap_%2%";
    enable_oracle_block on;
    enable_bb_block on;
    enable_user_flags on;

    mbox_map {
      inbox { name INBOX; xlist "\\Inbox"; };
      draft { name Drafts; xlist "\\Drafts"; };
      spam { name Spam; xlist "\\Spam"; };
      sent { name Sent; xlist "\\Sent"; };
      trash { name Trash; xlist "\\Trash"; };
      outbox { name Outbox; xlist "Outbox"; };
    };

    // %include request_map.conf;

/*
    request_map {
      imap_status "imap_features_get_status?init_imap_if_disabled=true";
      all_folder_list "all_folder_list?format=plain";
      folder_list "folder_list?format=plain";
      folder_subscribe "folder_subscribed?fid=%1%&amp;value=%2%";
      folder_info "imap_folder_info?fname=%1%&amp;delimiter=%2%";
      sfolder_info "imap_folder_info?symbolic_name=%1%";
      folder_create "settings_folder_create?folder_name=%1%";
      folder_delete "settings_folder_delete_with_msgs?fid=%1%";
      folder_rename "settings_folder_imap_move?fid=%1%&amp;fname=%2%";
      sync_mailbox "imap_synchronize_folder?fname=%1%&amp;delimiter=%2%&amp;uid_validity=%3%&amp;mod_seq=%4%";
      ssync_mailbox "imap_synchronize_folder?symbolic_name=%1%&amp;uid_validity=%2%&amp;mod_seq=%3%";
      mailbox_list_by_uid "mailbox_list_imap_range?range_type=imapid&amp;current_folder=%1%&amp;range_start=%2%&amp;range_end=%3%";
      mailbox_list_by_order "mailbox_list_imap_range?range_type=rownum&amp;current_folder=%1%&amp;range_start=%2%&amp;range_end=%3%";
      get_structure "message_structure_imap?st_id=%1%";
      get_message_body "message_part_auth?st_id=%1%&amp;with_body=1";
      get_message_body_part "message_part_auth?st_id=%1%&amp;hid=%2%&amp;with_body=1";
      get_message_header "message_part_auth?st_id=%1%&amp;with_header=1";
      get_message_header_part "message_part_auth?st_id=%1%&amp;hid=%2%&amp;with_header=1";
      get_message "message_part_auth?st_id=%1%&amp;with_body=1&amp;with_header=1";
      get_message_part "message_part_auth?st_id=%1%&amp;hid=%2%&amp;with_body=1&amp;with_header=1";
      get_message_db_headers "message_header?ids=%1%";
      copy_messages "mailbox_oper";
      delete_messages "mailbox_oper";
      set_message_flags "message_imap_flags";
      append_message "imap_append";
      search_message_id "get_letters_by_message_id?fid=%1%&amp;message_id=%2%";
    };
  */
  };
};
